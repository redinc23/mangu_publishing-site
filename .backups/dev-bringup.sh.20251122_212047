#!/usr/bin/env bash
# ===== Dev bring-up from main (one-shot) =====
set -euo pipefail

log() { printf "\n%s %s\n" "$1" "$2"; }

log "ğŸ”" "Loading local credentials (or creating a stub)â€¦"
if [ ! -f scripts/credentials/local.sh ]; then
  mkdir -p scripts/credentials
  cat > scripts/credentials/local.sh <<'ENV'
# Fill these with REAL values; this file is gitignored.
export GITHUB_TOKEN="REPLACE_ME"
export GITHUB_USER="REPLACE_ME"
export AWS_ACCESS_KEY_ID="REPLACE_ME"
export AWS_SECRET_ACCESS_KEY="REPLACE_ME"
export AWS_REGION="us-east-1"
# Add any others your app needs:
# export STRIPE_SECRET_KEY="REPLACE_ME"
# export DEEPSEEK_API_KEY="REPLACE_ME"
ENV
  chmod 600 scripts/credentials/local.sh
  echo "Created scripts/credentials/local.sh â€” update with real values after first run."
fi
# shellcheck disable=SC1091
source scripts/credentials/local.sh || true

log "ğŸŒ¿" "Ensuring weâ€™re on mainâ€¦"
# If working tree is dirty and prevents checkout, stash it temporarily
if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
  STASHED=0
  if ! git checkout -q main 2>/dev/null; then
    log "ğŸ§º" "Stashing local changes to switch branchesâ€¦"
    git stash -u -m "auto-stash: dev bring-up $(date +%F-%T)" && STASHED=1
  fi
  git checkout main
  [ "$STASHED" = "1" ] && log "â„¹ï¸" "Your work was stashed. Re-apply later with: git stash pop"
else
  git checkout main
fi
git pull --ff-only || true

log "ğŸ”" "Checking Node & Homebrew servicesâ€¦"
node -v || { echo "âŒ Node not installed. Install Node (LTS) and re-run."; exit 1; }
npm -v || { echo "âŒ npm not installed. Install Node/npm and re-run."; exit 1; }

# Check for Homebrew
if ! command -v brew >/dev/null 2>&1; then
  echo "âŒ Homebrew not found. Install Homebrew from https://brew.sh and re-run."
  exit 1
fi

# Check and start PostgreSQL service
log "ğŸ˜" "Checking PostgreSQL serviceâ€¦"
if ! brew services list | grep -q "postgresql.*started"; then
  log "ğŸš€" "Starting PostgreSQL serviceâ€¦"
  brew services start postgresql@16 2>/dev/null || brew services start postgresql 2>/dev/null || {
    echo "âš ï¸  PostgreSQL not installed. Install with: brew install postgresql@16"
    echo "   Or set DATABASE_URL to your existing PostgreSQL instance."
  }
fi

# Check and start Redis service
log "ğŸ”´" "Checking Redis serviceâ€¦"
if ! brew services list | grep -q "redis.*started"; then
  log "ğŸš€" "Starting Redis serviceâ€¦"
  brew services start redis 2>/dev/null || {
    echo "âš ï¸  Redis not installed. Install with: brew install redis"
    echo "   Or set DISABLE_REDIS=1 to run without Redis."
  }
fi

# Wait for services to be ready
log "ğŸ“¡" "Waiting for services to be ready (up to ~10s)â€¦"
for i in {1..10}; do
  pg_isready -h localhost -p 5432 >/dev/null 2>&1 && break
  sleep 1
done

# Check if database exists, create if not
if ! psql -h localhost -U "$USER" -lqt | cut -d \| -f 1 | grep -qw mangu_db 2>/dev/null; then
  log "ğŸ“¦" "Creating database mangu_dbâ€¦"
  createdb mangu_db 2>/dev/null || echo "âš ï¸  Could not create database. Create manually with: createdb mangu_db"
fi

log "ğŸ“¦" "Installing npm deps (safe to re-run)â€¦"
npm --prefix server install
npm --prefix client install

log "ğŸš€" "Starting API & UIâ€¦"
# Start both in the background if we can't auto-open terminals
started_bg=0
if command -v osascript >/dev/null 2>&1 && [ "$(uname)" = "Darwin" ]; then
  osascript <<'OSA' >/dev/null 2>&1 || true
tell application "Terminal"
  do script "cd '$(pwd)'; source scripts/credentials/local.sh; npm --prefix server run dev"
  do script "cd '$(pwd)'; source scripts/credentials/local.sh; npm --prefix client run dev"
end tell
OSA
else
  # Fallback: background both processes here
  ( source scripts/credentials/local.sh; npm --prefix server run dev ) >/tmp/server.dev.log 2>&1 & disown || true
  ( source scripts/credentials/local.sh; npm --prefix client run dev ) >/tmp/client.dev.log 2>&1 & disown || true
  started_bg=1
fi

log "ğŸ§ª" "Health checks (retrying for ~20s)â€¦"
api_ok=0
ui_ok=0
for i in {1..20}; do
  curl -fsS http://localhost:3001 >/dev/null 2>&1 && api_ok=1 || true
  curl -fsS http://localhost:5173 >/dev/null 2>&1 && ui_ok=1 || true
  [ "$api_ok" -eq 1 ] && [ "$ui_ok" -eq 1 ] && break
  sleep 1
done

[ "$api_ok" -eq 1 ] && echo "âœ… API reachable at http://localhost:3001" || echo "âš ï¸ API not up yet"
[ "$ui_ok" -eq 1 ] && echo "âœ… UI reachable at  http://localhost:5173" || echo "âš ï¸ UI not up yet"

log "ğŸ§°" "Optional deeper checkâ€¦"
if [ -x ./test-setup.sh ]; then
  ./test-setup.sh || true
else
  echo " (./test-setup.sh not found/executable â€” skipping)"
fi

if [ "$started_bg" -eq 1 ]; then
  echo
  echo "ğŸ“œ Logs (tail in another shell if needed):"
  echo "  tail -f /tmp/server.dev.log"
  echo "  tail -f /tmp/client.dev.log"
fi

echo
echo "ğŸ‰ Done. API: http://localhost:3001   UI: http://localhost:5173"
