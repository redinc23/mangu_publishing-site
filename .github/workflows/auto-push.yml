name: Auto Push & PR

on:
  # Run on schedule (every 6 hours)
  schedule:
    - cron: '0 */6 * * *'
  
  # Run on manual trigger
  workflow_dispatch:
    inputs:
      force:
        description: 'Force push even if no changes'
        required: false
        default: 'false'
  
  # Run on push to main (optional - for testing)
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  auto-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
      
      - name: Install dependencies
        run: |
          cd client
          npm ci
      
      - name: Run build
        run: |
          cd client
          npm run build
      
      - name: Check for changes
        id: changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are uncommitted changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi
      
      - name: Create branch and commit
        if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force == 'true'
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="auto-update-${TIMESTAMP}"
          
          echo "Creating branch: ${BRANCH_NAME}"
          git checkout -b "${BRANCH_NAME}"
          
          # Add all changes
          git add -A
          
          # Commit if there are changes
          if [ -n "$(git diff --cached)" ]; then
            git commit -m "chore: Auto-update $(date +"%Y-%m-%d %H:%M:%S")
            
            - Auto-generated by GitHub Actions
            - Branch: ${BRANCH_NAME}
            - Workflow: ${{ github.workflow }}
            - Run: ${{ github.run_id }}"
          fi
          
          git push origin "${BRANCH_NAME}"
          
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
      
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = process.env.BRANCH_NAME;
            const timestamp = new Date().toISOString();
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Auto-update: ${timestamp}`,
              head: branchName,
              base: 'main',
              body: `## ðŸ¤– Automated Update
              
              This PR was automatically generated by GitHub Actions.
              
              ### Generated
              ${timestamp}
              
              ### Workflow
              - Run: ${{ github.run_id }}
              - Workflow: ${{ github.workflow }}
              - Actor: ${{ github.actor }}
              
              ### Branch
              \`${branchName}\`
              
              ---
              *This is an automated PR. Please review before merging.*
              
              /auto-merge
              `
            });
            
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['automated', 'dependencies']
            });
      
      - name: Comment on PR
        if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = process.env.BRANCH_NAME;
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });
            
            if (prs.length > 0) {
              const pr = prs[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `## ðŸ“Š Build Status
                
                âœ… Build completed successfully
                âœ… Changes committed
                âœ… PR created
                
                ### Next Steps
                - Review the changes
                - Merge if approved
                - Or close if not needed`
              });
            }
      
      - name: Skip if no changes
        if: steps.changes.outputs.has_changes == 'false' && github.event.inputs.force != 'true'
        run: |
          echo "No changes detected. Skipping PR creation."
          exit 0

