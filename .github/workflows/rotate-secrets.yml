name: Rotate Secrets

on:
  schedule:
    # Run on the 1st of every month at 2 AM UTC
    - cron: '0 2 1 * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rotate secrets for'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      secret_type:
        description: 'Type of secret to rotate'
        required: true
        default: 'jwt'
        type: choice
        options:
          - jwt
          - stripe
          - all

env:
  AWS_REGION: us-west-2

jobs:
  rotate-secrets:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rotate secrets
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
          FORCE_ROTATION: 'true'
        run: |
          chmod +x scripts/rotate-keys.sh
          SECRET_TYPE="${{ github.event.inputs.secret_type || 'jwt' }}"
          ./scripts/rotate-keys.sh "$SECRET_TYPE" --force

      - name: Verify rotation
        run: |
          echo "âœ… Secret rotation completed"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Secret type: ${{ github.event.inputs.secret_type || 'jwt' }}"

      - name: Notify success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âœ… Secrets Rotated - ${{ github.event.inputs.environment || 'production' }}`,
              body: `## Secret Rotation Completed
              
              **Environment:** ${{ github.event.inputs.environment || 'production' }}
              **Secret Type:** ${{ github.event.inputs.secret_type || 'jwt' }}
              **Date:** ${new Date().toISOString()}
              **Workflow:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ### Next Steps
              - Monitor CloudWatch logs for authentication errors
              - Verify application functionality
              - Update documentation if needed
              
              **Note:** Services have been automatically restarted to use new credentials.
              `,
              labels: ['security', 'automated']
            };
            
            await github.rest.issues.create(issue);

      - name: Notify failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Secret Rotation Failed - ${{ github.event.inputs.environment || 'production' }}`,
              body: `## Secret Rotation Failed
              
              **Environment:** ${{ github.event.inputs.environment || 'production' }}
              **Secret Type:** ${{ github.event.inputs.secret_type || 'jwt' }}
              **Date:** ${new Date().toISOString()}
              **Workflow:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ### Action Required
              Review the workflow logs and manually rotate secrets if needed.
              See [Secret Rotation Runbook](./docs/runbooks/secret-rotation.md)
              `,
              labels: ['security', 'incident', 'urgent']
            };
            
            await github.rest.issues.create(issue);
