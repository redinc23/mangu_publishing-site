name: Automated Secret Rotation

on:
  schedule:
    # Run every 90 days at 2 AM UTC
    - cron: '0 2 */90 * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual changes)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      environment:
        description: 'Environment to rotate secrets for'
        required: true
        default: 'production'
        type: choice
        options:
          - 'production'
          - 'staging'
          - 'development'

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  rotate-secrets:
    name: Rotate Secrets
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROTATION_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq awscli

      - name: Verify AWS access
        run: |
          aws sts get-caller-identity
          echo "AWS credentials configured successfully"

      - name: Run secret rotation
        id: rotation
        env:
          PROJECT_NAME: mangu-publishing
          ENVIRONMENT: ${{ inputs.environment || 'production' }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
        run: |
          chmod +x scripts/rotate-secrets.sh
          
          echo "Starting secret rotation..."
          echo "Environment: $ENVIRONMENT"
          echo "Dry Run: $DRY_RUN"
          
          # Run rotation script
          if scripts/rotate-secrets.sh rotate; then
            echo "rotation_status=success" >> $GITHUB_OUTPUT
            echo "✅ Secret rotation completed successfully"
          else
            echo "rotation_status=failed" >> $GITHUB_OUTPUT
            echo "❌ Secret rotation failed"
            exit 1
          fi

      - name: Upload rotation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rotation-logs-${{ inputs.environment || 'production' }}-${{ github.run_number }}
          path: /tmp/rotation-report-*.txt
          retention-days: 90

      - name: Notify on success
        if: steps.rotation.outputs.rotation_status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ inputs.environment || 'production' }}';
            const dryRun = '${{ inputs.dry_run || 'false' }}';
            
            const title = `✅ Secret Rotation ${dryRun === 'true' ? '(Dry Run)' : 'Completed'} - ${environment}`;
            const body = `
            ## Secret Rotation Report
            
            **Environment:** ${environment}
            **Date:** ${new Date().toISOString()}
            **Dry Run:** ${dryRun}
            **Status:** ✅ Success
            
            ### Rotated Secrets
            - JWT signing secrets
            - Database credentials
            - API keys
            
            ### Next Steps
            ${dryRun === 'true' ? '- Review logs and run without dry-run mode' : '- Monitor application for any issues'}
            - Verify service health at https://status.mangupublishing.com
            
            ### Logs
            Detailed logs are available in the workflow artifacts.
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automation', 'secret-rotation']
            });

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ inputs.environment || 'production' }}';
            
            const title = `❌ Secret Rotation Failed - ${environment}`;
            const body = `
            ## Secret Rotation Failure
            
            **Environment:** ${environment}
            **Date:** ${new Date().toISOString()}
            **Status:** ❌ Failed
            
            ### Action Required
            1. Review workflow logs for error details
            2. Check AWS CloudWatch logs for rotation failures
            3. Verify IAM permissions for rotation role
            4. Run manual rollback if necessary:
               \`\`\`bash
               scripts/rotate-secrets.sh rollback <secret-name>
               \`\`\`
            
            ### Contact
            @security-team - Immediate attention required
            
            **Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'urgent', 'secret-rotation', 'failure'],
              assignees: ['security-team']
            });

  verify-rotation:
    name: Verify Rotation
    runs-on: ubuntu-latest
    needs: rotate-secrets
    if: always() && needs.rotate-secrets.result == 'success'
    environment: ${{ inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROTATION_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Verify service health
        env:
          ENVIRONMENT: ${{ inputs.environment || 'production' }}
        run: |
          echo "Waiting for services to stabilize..."
          sleep 60
          
          # Check ECS service health
          SERVICE_NAME="mangu-publishing-${ENVIRONMENT}-server"
          CLUSTER_NAME="mangu-publishing-${ENVIRONMENT}"
          
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster "$CLUSTER_NAME" \
            --services "$SERVICE_NAME" \
            --query 'services[0].runningCount' \
            --output text)
          
          DESIRED_COUNT=$(aws ecs describe-services \
            --cluster "$CLUSTER_NAME" \
            --services "$SERVICE_NAME" \
            --query 'services[0].desiredCount' \
            --output text)
          
          if [ "$SERVICE_STATUS" = "$DESIRED_COUNT" ]; then
            echo "✅ Service is healthy (${SERVICE_STATUS}/${DESIRED_COUNT} tasks running)"
          else
            echo "❌ Service health check failed (${SERVICE_STATUS}/${DESIRED_COUNT} tasks running)"
            exit 1
          fi

      - name: Run smoke tests
        run: |
          chmod +x scripts/smoke-tests.sh
          if ! scripts/smoke-tests.sh; then
            echo "❌ Smoke tests failed after rotation"
            exit 1
          fi
          echo "✅ All smoke tests passed"

      - name: Generate rotation summary
        if: always()
        run: |
          cat > rotation-summary.md <<'EOF'
          # Secret Rotation Summary
          
          ## Status
          - Rotation: ✅ Completed
          - Verification: ✅ Passed
          - Service Health: ✅ Healthy
          
          ## Timeline
          - Started: ${{ github.event.repository.updated_at }}
          - Completed: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          ## Next Rotation
          - Scheduled: $(date -d '+90 days' +"%Y-%m-%d")
          EOF
          
          cat rotation-summary.md

      - name: Upload summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rotation-summary-${{ inputs.environment || 'production' }}
          path: rotation-summary.md
          retention-days: 365
