name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_SERVER_REPOSITORY: mangu-publishing/server
  ECR_CLIENT_REPOSITORY: mangu-publishing/client
  ECS_CLUSTER: mangu-publishing-cluster-production
  ECS_SERVER_SERVICE: mangu-publishing-server-production
  ECS_CLIENT_SERVICE: mangu-publishing-client-production

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Run tests
        run: npm test -- --ci

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build server image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_SERVER_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_SERVER_REPOSITORY:latest \
            -f Dockerfile .

      - name: Build client image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_CLIENT_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_CLIENT_REPOSITORY:latest \
            -f Dockerfile.client \
            --build-arg VITE_API_URL=${{ secrets.VITE_API_URL }} \
            .

      - name: Scan server image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_SERVER_REPOSITORY }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-server-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Scan client image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_CLIENT_REPOSITORY }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-client-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Push server image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_SERVER_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_SERVER_REPOSITORY:latest

      - name: Push client image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_CLIENT_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_CLIENT_REPOSITORY:latest

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd server
          npm ci
          npm run migrate

      - name: Deploy server to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVER_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy client to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_CLIENT_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for server deployment
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVER_SERVICE }} \
            --region ${{ env.AWS_REGION }}

      - name: Wait for client deployment
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_CLIENT_SERVICE }} \
            --region ${{ env.AWS_REGION }}

      - name: Run smoke tests
        run: |
          chmod +x scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh ${{ secrets.PRODUCTION_URL }}

      - name: Check deployment status
        if: failure()
        run: |
          echo "âš ï¸ Deployment or smoke tests failed!"
          echo "ECS Circuit Breaker will automatically rollback unhealthy deployments."
          echo ""
          echo "Checking current deployment status..."
          
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVER_SERVICE }} ${{ env.ECS_CLIENT_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[*].{Service:serviceName,Status:deployments[0].status,Rollout:deployments[0].rolloutState,Desired:desiredCount,Running:runningCount}' \
            --output table

      - name: Notify failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸš¨ Deployment Failed
            
            **Branch:** \`${{ github.ref_name }}\`
            **Commit:** \`${{ github.sha }}\`
            **Workflow:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### Status
            ECS Circuit Breaker will automatically rollback if health checks fail.
            
            ### Next Steps
            1. Review CloudWatch logs: \`/ecs/${{ env.ECS_CLUSTER }}\`
            2. Check smoke test output in workflow logs
            3. Verify ECS service events for rollback status
            4. If circuit breaker didn't trigger, manual rollback may be needed
            
            ### Manual Rollback (if needed)
            See [docs/runbooks/rollback.md](./docs/runbooks/rollback.md) for procedures.
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number || context.payload.pull_request?.number,
              body: comment
            }).catch(() => console.log('No PR to comment on'))
